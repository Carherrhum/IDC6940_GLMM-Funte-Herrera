---
title: "Generalized Linear Mixed Models"
subtitle: "An Analysis on National Maternal Mortality"
author: "Carolyn Herrera & Catherine Funte (Advisor: Dr. Cohen)"
date: '`r Sys.Date()`'
format:
  html:
    code-fold: true
    css: styles.css
course: Capstone Projects in Data Science
bibliography: references.bib # file contains bibtex for references
#always_allow_html: true # this allows to get PDF with HTML features
self-contained: true
execute: 
  warning: false
  message: false
editor: 
  markdown: 
    wrap: 72
---
Slides: [slides.html](slides.html){target="_blank"} ( Go to `slides.qmd`
to edit)

## Introduction


  Generalized Linear Mixed Models (GLMMs) are a flexible class of statistical models that combine the strengths of two powerful frameworks: Generalized Linear Models (GLMs) and Mixed-Effects Models [@agresti2015foundations]. Like GLMs, GLMMs can model non-normal outcome variables, such as binary, count, or proportion data. However, extend GLMs by incorporating random effects, which account for variability due to grouping or clustering, correlated observations, and overdispersion. This makes GLMMs well-suited for complex data structures involving temporal or spatial correlation, nested hierarchies, heterogeneity of variance, and repeated measurements [@zuur2009mixed].  

  In practice, GLMMs are especially useful when data points are not independent—for example, when students are nested within schools, patients are treated within hospitals, or repeated measures are taken from the same subject over time. Thall [@thall1988mixed] noted that longitudinal clinical trials often struggle to determine whether observed changes in outcomes are attributable to treatment effects or simply the passage of time. This ambiguity makes it difficult to compare outcomes between subjects. GLMMs address this by modeling for within-subject dependence, incorporating covariates, treating time as a function, capturing variability between patients, and provides both flexibility and tractability. The random effects help model the correlation within clusters and allow for unobserved heterogeneity—differences that are not captured by the measured covariates.

GLMMs are good for:

-  Handling hierarchical or grouped data (e.g., students within classrooms, patients within clinics) [@lee1996hierarchical]


-  Modeling non-normal outcomes, such as:


   -  Binary outcomes (using logistic GLMMs) [@wang2017generalized]


   -  Count data (using Poisson or negative binomial GLMMs) [@candy2000application]


   -  Proportions or rates [@salinas2023generalized]


-  Reducing bias and inflated Type I error rates that can result from ignoring data structure [@thompson2022cluster]


  GLMMs are ideal for analyzing complex data structures that involve non-Gaussian response variables, making them indispensable in fields like medicine, ecology, education, and social sciences. For example, Tawiah et al. [@tawiah2020zero] describe zero-inflated Poisson GLMMs—an extension of Poisson GLMM that allows for overdispersion due to a prevalence of zeros in the data, common in health sector data . The paper compares four models: a Poisson GLM, a zero-inflated Poisson GLM, a Poisson GLMM, and a zero-inflated Poisson GLMM, applied to clustered maternal mortality data.The study found the zero-inflated Poisson GLMM to yield to best results. Similarly, Owili et al. [@owili2020impacts] utilize a GLMM with Poisson link function to investigate the impact of particulate matter on maternal and infant mortality globally and regionally. In their global analysis, year and country are modeled as random effects to account for variation in regional data. 

  This study investigates the potential risks faced by mothers in a post-Roe v. Wade context, with a particular focus on the systemic disparities that continue to affect women of color during childbirth. To analyze these risks, we will apply a Generalized Linear Mixed Model (GLMM), a robust statistical method suited for complex, hierarchical data. Our goal is to examine the relationship between maternal mortality and key explanatory variables, including age group, ethnicity, and whether the death occurred during the post-Dobbs era. These findings are especially relevant as they may provide evidence to inform public health interventions aimed at reducing maternal mortality among vulnerable populations, and to assess whether the legal and healthcare shifts following the Dobbs v. Jackson Women's Health Organization decision have contributed to an increase in maternal deaths.

## Methods

#### Math Background

  GLMMs extends GLMs, by including random effects to account for correlation and variability within clustered or repeated observations. GLMMs can also be viewed as an extension of Linear Mixed Models (LMMs), which are adapted for non-Gaussian outcome distributions [@salinas2023generalized]. 
  
Let

- $\mathbf{y}$ be a $Nx1$ column vector outcome variable

- $\mathbf{X}$ be a $Nxp$ matrix for the $p$ predictor variables

- $\boldsymbol{\beta}$ be a $px1$ column vector of the fixed effects coefficients

- $\mathbf{Z}$ is a $Nxq$ matrix of the $q$ random effects

- $\mathbf{u}$ is a $qx1$ vector of random effects, and

- $\boldsymbol{\epsilon}$ is a $Nx1$ column vector of the residuals 

Then the general equation for the model is given by:

$$\mathbf{y}=\mathbf{X}\boldsymbol{\beta}+\mathbf{Z}{u}+\boldsymbol{\epsilon}$$
[@salinas2023generalized].
  In GLMMs, the response variable $\mathbf{y}$ is assumes to follow a distribution from the exponential family. The model introduces a linear predictor, $\eta$, defined as: 
$$\boldsymbol{\eta}=\mathbf{X}\boldsymbol{\beta}+\mathbf{Z}\boldsymbol{\lambda}$$
A link function relates the expected value of the response variable to this linear predictor:
$$g(E(\mathbf{y}))=\boldsymbol{\eta}$$
The choice of link function depends on the distribution of the outcome variable. In this study, the data is overdispersed counts, which makes the Negative Binomial distribution appropriate. Therefore, we will use a log link function.  
$$g(\cdot)=log_e(\cdot)$$
  Parameter estimation in GLMMs involves maximizing the log-likelihood or minimizing the negative log-likelihood [@salinas2023generalized]. Model-derived quantities such as estimated means or least-squares means are initially computed on the model scale and can then be back-transformed to the data scale using the inverse of the link function.
  
  The Negative Binomial Distribution is defined as:
$$
f(y;k,{\mu})=\frac{\Gamma(y+k)}{\Gamma(k)*(y+1)}\left(\frac{k}{\mu+k}\right)^{k}\left(1-\frac{k}{\mu+k}\right)^{y}
$$
where:

 - $\mu$ is the mean of the distribution,
 
 - $k$ is the dispersion parameter, and
 
 - $\Gamma(\cdot)$ is the gamma function, where $\Gamma(y+1)=y!$
 
The mean and variance are:

 - $E(Y) = \mu$
 
 - $\text{Var}(Y) = \mu + \frac{\mu^2}{k}$
 
  The dispersion parameter $k$ controls the degree of overdispersion. As $k \to \infty$, the variance approaches the mean, and the Nagative Binomial converges to the Poisson distribution. However, when $k$ is small, the variance increases, indicating significant overdispersion, making the Negative Binomial distribution preferable to Poisson in such cases [@zuur2009mixed]. 

#### Assumptions

  Before deciding to use a GLMM for our data, we had to check some assumptions (specific to our Negative Binomial distributed data). 

- The response variable and the predictors have a linear relationship within the levels of random effects. 
- The response variable is assumed to follow a negative binomial distribution, with $\sigma^2>\mu$.
- The residuals and random effects are independent.
- The random effects are assumed to be normally distributed, with mean 0 and variance $\sigma$.

#### Model Selection and Implementation

  The quadratic nature of the Negative Binomial distribution's mean-variance relationship is ideal for overdispersed count data that the Poisson distribution cannot accommodate. Overdispersion is a given for populations due to their heterogeneity that  aggregation processes such as  community clusters form with shared traits such as ethnicity. Our data includes community cluster groups such as ethnicity and age groups.  The negative binomial model is desirable also due to its easily interpretable dispersion parameter as a measure of aggregation and its tractability due to closed form expression of probability mass function which helps in  convenient model inference and estimation.
Since our data is longitudinal, a Negative Binomial GLMM is ideal since measurements are taken over time. We incorporate Year as a random effect because it could explain for variation in our model which could not be explained by our fixed effects such as ethnicity or age group.

  We conduct our analyses in R [@R-base], using the following packages and functions for modeling:

- `lme4` [@lme4]:

  - `glmer()` for Poisson GLMMs

- `glmmTMB` [@glmmTMB]:

  - `glmmTMB(..., family = nbinom2)` for Negative Binomial GLMMs
  
Each function employs different methods for parameter estimation:

- `glmmTMB` uses Adaptive Gauss-Hermite Quadrature (AGQ) or Laplace approximation, along with Wald Z-tests for fixed-effect significance [@glmmTMB].

- `lme4` defaults to the Laplace approximation for log-likelihood estimation and can also use Gauss-Hermite quadrature for more precise estimation but reduced speed [@lme4]. 

Densities, such as maternal deaths per number of live births, can be modeled using count data with an offset variable [@zuur2009mixed]. While maternal mortality rate could be modeled directly, using an offset, specifically log(Live Births), enables more stable and interpretable modeling of raw counts.

  We plan to compare models both with and without the offset term, evaluating them using the Akaike Information Criterion (AIC). The model with the lower AIC is preferred, as it balances goodness of fit with model complexity.

  The selection of fixed vs. random effects in our models depend on the specific research question.
  
Random effects may include:

- Year

- Month

- Nested terms such as Month/Year

Fixed effects may include:

- Age group

- Ethnicity

- Year (if not treated as random)

- Dobbs Era (pre- or post-)

## Analysis and Results

### Data Exploration and Visualization

  The data we used come from the National Vital Statistics System, an organization that provides national data about births, deaths, marriages, divorces, and fetal deaths. It is a collaboration between the National Center for Health Statistics (NCHS) (a part of the CDC) and state vital records offices. [@CDC_2016] This dataset is the Vital Statistics Rapid Release (VSRR) Provisional Maternal Death Counts and Rates, in the form of a .csv file. The dataset contains monthly death counts and death rates from 2019 to 2024 by race and ethnicity, age and overall. Rates are maternal deaths per 100,000 live births. For this dataset, a maternal death is defined as "the death of a woman while pregnant or within 42 days of termination of pregnancy irrespective of the duration and the site of the pregnancy, from any cause related to or aggravated by the pregnancy or its management, but not from accidental or incidental causes." [@CDC_2025]. It is worth noting that this dataset is provisional, in that the data is updated quarterly as more data is received, and data from numbers from previous years is more reliable than numbers from recent years. The data was last updated April 6, 2025.


```{r, warning=FALSE, echo=T, message=FALSE}
# loading packages 
library(tidyverse)
library(knitr)
library(ggthemes)
library(ggrepel)
library(dslabs)
library(ggplot2)
library(patchwork) # For combining plots
library(ggpubr)
library(DataExplorer) #For EDA
options(repos = c(CRAN = "https://cloud.r-project.org"))#specify cran mirror
if (!require("lme4")) install.packages("lme4")#if required to install
library(lme4)
##to check if model is overdispersed'
if (!require("performance")) install.packages("performance")#if required to install
library(performance)
##Overdispersion is detected with Poisson model thus we must use negative binomial model
if (!require("glmmTMB")) install.packages("glmmTMB")#if required to install
library(glmmTMB)
if (!require("ggeffects")) install.packages("ggeffects")
library(ggeffects)
if (!require("AICcmodavg")) install.packages("AICcmodavg")
library(AICcmodavg)
```


```{r, warning=FALSE, echo=TRUE}

df <- read.csv("data/VSRR_Provisional_Maternal_Death_Counts_and_Rates_20250726.csv")#loading data
#variables- Maternal.Deaths--outcome variable
#Live.Births---offset variable since it is maternal deaths per live births
#Subgroup- ethnicity and year of mother must be edited --- these are fixed
#Year.of.Death---random effect variable
#Summary
#renaming columns
df<-df%>% 
  rename(Year= Year.of.Death, Month= Month.of.Death, Maternal_Deaths= Maternal.Deaths, Live_Births= Live.Births, Maternal_Mortality_Rate= Maternal.Mortality.Rate, Time_Period= Time.Period, Month_Ending_Date= Month.Ending.Date, Data_As_Of= Data.As.Of) 
  
filtered_df<- df%>% filter(Maternal_Deaths > 0, Live_Births > 100) #Filtering out potential stange data
  
test_df <- na.omit(filtered_df)#filtered na

```

```{r}
#Summary Statistics

deaths_df <-test_df %>%
  mutate(
    Ethnicity = case_when(
      Group == "Race and Hispanic origin" ~ Subgroup,
      TRUE ~ NA_character_
    ),
    Age_Group = case_when(
      Group == "Age" ~ Subgroup,
      TRUE ~ NA_character_
    ),
    Is_Total = Subgroup == "Total"
  ,
  Year = as.factor(Year),
  Month= as.factor(Month),
  Ethnicity=as.factor(Ethnicity),
  Age_Group=as.factor(Age_Group))#mutating groups

deaths_df_ethnic<-deaths_df %>%
  filter(!is.na(Ethnicity))%>%
  mutate(Ethnicity = Subgroup)###filter out is total if ethnicity or age group are na

deaths_df_age <-deaths_df %>%
  filter(!is.na(Age_Group)) %>%
  mutate(Age_Group = Subgroup)


merged_deaths_df <-  bind_rows(deaths_df_ethnic, deaths_df_age)  #merge both df

#setting factor levels
deaths_df3 <- merged_deaths_df %>%
  mutate(
    Ethnicity = factor(Ethnicity, levels = c(
      "Asian, Non-Hispanic", "Black, Non-Hispanic", "White, Non-Hispanic",
      "Hispanic", "American Indian or Alaska Native, Non-Hispanic",
      "Native Hawaiian or Other Pacific Islander, Non-Hispanic", "Unknown"
    )),
    Age_Group = factor(Age_Group, levels = c("Under 25 years", "25-39 years", "40 years and over", "Unknown"))
  )

#mutating any NAs with unknown
deaths_df3<- deaths_df3 %>%
   mutate(
    Ethnicity = replace_na(Ethnicity, "Unknown"),
    Age_Group = replace_na(Age_Group, "Unknown")
  )

# make variable in which we combine Year and Month into a for of a date to create later variable, or use month ending date?
deaths_df3$Date <- as.Date(paste(deaths_df3$Year, deaths_df3$Month, "01", sep = "-"))

# Dobbs was decided June 24, 2022
cutoff <- as.Date("2022-06-24")##when Roe v.Wade was overturned

deaths_df3$Dobbs_Era <- ifelse(deaths_df3$Date < cutoff, "Pre-Dobbs", "Post-Dobbs")
deaths_df3$Dobbs_Era <- factor(deaths_df3$Dobbs_Era, levels = c("Pre-Dobbs", "Post-Dobbs"))

df_age_year <- deaths_df %>%
  filter(!is.na(Age_Group), !is.na(Year)) %>%
  group_by(Year, Age_Group) %>%
  summarise(Maternal_Deaths = sum(Maternal_Deaths, na.rm = TRUE))
#df_age_year

df_total_year <-deaths_df%>%
  filter(Group=="Total") %>%
  group_by(Year, Is_Total) %>%
  summarise(Maternal_Deaths = sum(Maternal_Deaths, na.rm = TRUE))
#df_total_year
```
  The below chart gives an idea of the missing values in the dataset. It seems like there are many NAs in ethnicity and age group, certainly more than is acceptable. The dataset indicates that Maternal Deaths between 1 and 9 are suppressed for privacy reasons. With more investigation, it appears that the racial/ethnic group "Native Hawaiian or Other Pacific Islander, Non-Hispanic" has NA for 70 (all but 2) Maternal Deaths values. We decided to omit this subgroup entirely. There are 58 missing Maternal Mortality Rate entries in "American Indian or Alaska Native, Non-Hispanic", which will not be an issue as we are not using rate explicitly in our model (though we will examine it during our Exploratory Data Analysis). Finally, there are seven NA Maternal Deaths also in the "American Indian or Alaska Native, Non-Hispanic" category, a number that is reasonable to omit. 
```{r}
plot_missing(df)
```
  Since our data is longitudinal, it is easy to visualize with graphs. Below is a bar chart that shows the distribution of Maternal Deaths by racial/ethnic group. The counts indicated the sum of the Maternal Deaths for each group over the span of the data (2019-2024). Since these are sums of maternal death counts, they are reflective of the relative population of each group. Namely, white women had the largest number of deaths as they are the largest population, and American Indian or Alaska Native had the least deaths as the smallest population. 
```{r}
#Data Exploration Graphs
colors=c('yellow','orange', 'blue', 'red', 'green')
df_ethnicity <- deaths_df %>%
    filter(!is.na(Ethnicity)) %>%
    group_by(Ethnicity) %>%
    summarise(Maternal_Deaths = sum(Maternal_Deaths, na.rm = TRUE))
desired_order <- c("White, Non-Hispanic", "Black, Non-Hispanic", "Hispanic", "Asian, Non-Hispanic", "American Indian or Alaska Native, Non-Hispanic")
df_ethnicity$Ethnicity <- factor(df_ethnicity$Ethnicity, levels = desired_order)
ggplot(df_ethnicity, aes(x = Ethnicity, y = Maternal_Deaths, fill = Ethnicity)) +
  geom_col() +
  labs(
    title = "Maternal Mortality Totals by Ethnicity",
    x = "Ethnicity",
    y = "Maternal Deaths"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 10, hjust = 1, size = 6),  # angle and size
    legend.position = "none")
```

```{r,echo=FALSE,include=FALSE}
#kind of unnecessary plot so hidden
df_tot_year_ts<-ts(df_total_year$Maternal_Deaths, start = c(2019), frequency = 1)
plot.ts(df_tot_year_ts,main='Yearly Maternal Deaths 2019-2024',xlab='Year',ylab='Maternal Deaths',col='navy')
```

Below is a plot of monthly maternal deaths. The death count starts at 660 in January 2019, increases over time to a peak of 1249 in February 2022, decreases until November 2023 to 665, increases again slightly then holds close to 700 in the latter part of 2024. 

```{r}
total_df <- deaths_df%>%
  filter(Group=='Total')
total_ts <- ts(total_df$Maternal_Deaths,start=c(2019,1),frequency=12)
plot.ts(total_ts,main='Monthly Maternal Deaths',ylab='Maternal Deaths',xlab='Time',col='navy')  
```
Similar to the above plot, this shows the monthly maternal death **rate**. The rate is considered the number of deaths per 100,000 live births. Since the number of live births is roughly constant, with only small fluctuations over the six year period, the monthly maternal death rate plot has the nearly identical shape as the monthly maternal death plot. The death rate goes from 17.4 in January 2019, to 33.8 in February 2022, to 18.4 in November 2023, then hovers around 19.3 in late 2024.
```{r}
df_tot_year_rate <- deaths_df%>%
  filter(Group=='Total')%>%
  select(Maternal_Mortality_Rate)
df_tot_year_rate_ts<-ts(df_tot_year_rate$Maternal_Mortality_Rate, start = c(2019,1), frequency = 12)
plot.ts(df_tot_year_rate_ts,main='Monthly Maternal Mortality Rate',xlab='Year',ylab='Maternal Deaths per 100,000 Live Births',col='navy')
```
Below are plots with maternal deaths and maternal mortality rate, both by ethnicity. In the left graph, note that white, black, and Hispanic deaths mirror the spike from the total monthly death plot, but Asian and American Indian or Alaska Native deaths stay steady. The right plot shows the highest death rates around 2022 for all ethnicities, including the two that did not experience an increase in deaths.
```{r,fig.width=10, fig.height=4}
par(mfrow = c(1, 2))
His <- filtered_df%>%
  filter(Subgroup=='Hispanic')%>%
  select(Maternal_Deaths)%>%
  rename(Hispanic=Maternal_Deaths)
bl <- filtered_df%>%
  filter(Subgroup=='Black, Non-Hispanic')%>%
  select(Maternal_Deaths)%>%
  rename('Black_Non-Hispanic' = Maternal_Deaths)
wh <- filtered_df%>%
  filter(Subgroup=='White, Non-Hispanic')%>%
  select(Maternal_Deaths)%>%
  rename('White_Non-Hispanic'=Maternal_Deaths)
as <- filtered_df%>%
  filter(Subgroup=='Asian, Non-Hispanic')%>%
  select(Maternal_Deaths)%>%
  rename('Asian_Non-Hispanic'=Maternal_Deaths)
aina <- df%>%
  filter(Subgroup=='American Indian or Alaska Native, Non-Hispanic')%>%
  select(Maternal_Deaths)%>% 
  rename('American_Indian_or_Alaska_Native, Non-Hispanic'=Maternal_Deaths)
ethn_ts <- bind_cols(His,bl,wh,as,aina) 
ethn_ts <- ts(ethn_ts, start=c(2019,1), frequency = 12)
colors=c('red','blue','green','orange','yellow')
plot.ts(ethn_ts, plot.type='single',main='Monthly Maternal Deaths by Ethnicity', ylab='Maternal Deaths',xlab='Time',col=colors)
legend("topleft",                     
       legend = c("Hispanic", "Black, Non-Hispanic", "White, Non-Hispanic",'Asian, Non-Hispanic','American Indian, Alaska Native, Non-Hisp'),  # Labels
       col = colors,                   
       lty = 1,                        
       lwd = 2,                     
       bty = "n",
       cex = 0.8)


HisR <- filtered_df%>%
  filter(Subgroup=='Hispanic')%>%
  select(Maternal_Mortality_Rate)%>%
  rename(Hispanic=Maternal_Mortality_Rate)
blR <- filtered_df%>%
  filter(Subgroup=='Black, Non-Hispanic')%>%
  select(Maternal_Mortality_Rate)%>%
  rename('Black_Non-Hispanic' = Maternal_Mortality_Rate)
whR <- filtered_df%>%
  filter(Subgroup=='White, Non-Hispanic')%>%
  select(Maternal_Mortality_Rate)%>%
  rename('White_Non-Hispanic'=Maternal_Mortality_Rate)
asR <- filtered_df%>%
  filter(Subgroup=='Asian, Non-Hispanic')%>%
  select(Maternal_Mortality_Rate)%>%
  rename('Asian_Non-Hispanic'=Maternal_Mortality_Rate)
ainaR <- df%>%
  filter(Subgroup=='American Indian or Alaska Native, Non-Hispanic')%>%
  select(Maternal_Mortality_Rate)%>% 
  rename('American_Indian_or_Alaska_Native, Non-Hispanic'=Maternal_Mortality_Rate)
ethnR_ts <- bind_cols(HisR,blR,whR,asR,ainaR) 
ethnR_ts <- ts(ethnR_ts, start=c(2019,1), frequency = 12)
colors=c('red','blue','green','orange','yellow')
plot.ts(ethnR_ts, plot.type='single',main='Monthly Maternal Mortality Rate by Ethnicity', ylab='Deaths per 100,000 Live Births',xlab='Time',col=colors)
legend("topleft",                     
       legend = c("Hispanic", "Black, Non-Hispanic", "White, Non-Hispanic",'Asian, Non-Hispanic','American Indian, Alaska Native, Non-Hisp'),  # Labels
       col = colors,                   
       lty = 1,                        
       lwd = 2,                     
       bty = "n",
       cex = 0.7)  
par(mfrow = c(1, 1))
```
Below are maternal deaths and death rate by age group. The greatest number of deaths occur in the 25-39 years group, reflective of the greater number of women of that age that give birth. Inc contrast, women 40 and over have the highest death rate, and women 25 and under have the smallest. 
```{r, fig.width=10, fig.height=4}
par(mfrow = c(1, 2))
ageu25 <- deaths_df%>%
  filter(Subgroup=='Under 25 years')%>%
  select(Maternal_Deaths)%>%
  rename('Under_25_years'=Maternal_Deaths)
age25 <- filtered_df%>%
  filter(Subgroup=='25-39 years')%>%
  select(Maternal_Deaths)%>%
  rename('25-39_years' = Maternal_Deaths)
ageo40 <- filtered_df%>%
  filter(Subgroup=='40 years and over')%>%
  select(Maternal_Deaths)%>%
  rename('40_years_and_over'=Maternal_Deaths)
age_ts <- bind_cols(ageu25,age25,ageo40) 
age_ts <- ts(age_ts, start=c(2019,1), frequency = 12)
colors=c('red','blue','green')
plot.ts(age_ts, plot.type='single',main='Monthly Maternal Deaths by Age Group', ylab='Maternal Deaths',xlab='Time',col=colors)
legend("topleft",                     
       legend = c("Under 25 Years", "25-39 Years", "40 Years and over"),  # Labels
       col = colors,                   
       lty = 1,                        
       lwd = 2,                     
       bty = "n",
       cex = 0.8) 

ageu25R <- deaths_df%>%
  filter(Subgroup=='Under 25 years')%>%
  select(Maternal_Mortality_Rate)%>%
  rename('Under_25_years'=Maternal_Mortality_Rate)
age25R <- filtered_df%>%
  filter(Subgroup=='25-39 years')%>%
  select(Maternal_Mortality_Rate)%>%
  rename('25-39_years' = Maternal_Mortality_Rate)
ageo40R <- filtered_df%>%
  filter(Subgroup=='40 years and over')%>%
  select(Maternal_Mortality_Rate)%>%
  rename('40_years_and_over'=Maternal_Mortality_Rate)
ageR_ts <- bind_cols(ageu25R,age25R,ageo40R) 
ageR_ts <- ts(ageR_ts, start=c(2019,1), frequency = 12)
colors=c('red','blue','green')
plot.ts(ageR_ts, plot.type='single',main='Monthly Maternal Mortality Rate by Age Group', ylab='Deaths per 100,000 live Births',xlab='Time',col=colors)
legend("topleft",                     
       legend = c("Under 25 Years", "25-39 Years", "40 Years and over"),  # Labels
       col = colors,                   
       lty = 1,                        
       lwd = 2,                     
       bty = "n",
       cex = 0.8) 
par(mfrow = c(1, 1))
```
Below are histograms showcasing the distribution of the outcome variable, Maternal Deaths. It roughly showcases a Negative Binomial Distribution. 
```{r}
#plot_histogram(deaths_df_ethnic$Maternal_Deaths,title='Histogram of Maternal Deaths - Ethnicity')
#plot_histogram(deaths_df_age$Maternal_Deaths, title='Histogram of Maternal Deaths - Age')
plot_histogram(total_df$Maternal_Deaths,title='Histogram of Maternal Deaths - Total')
```

```{r,echo=FALSE,include=FALSE}
#This is a graph showing observed deaths over time by using statistics of sum of dataframe data.
library(ggplot2)
ggplot(deaths_df3, aes(x = as.numeric(as.character(Year)), y = Maternal_Deaths, color = Ethnicity)) +
  stat_summary(fun = sum, geom = "line", size = 1) +
  stat_summary(fun = sum, geom = "point") +
  labs(title = "Observed Maternal Deaths Over Time by Ethnicity",
       x = "Year", y = "Observed Maternal Deaths") +
  theme_minimal()
```


```{r,echo=FALSE,include=FALSE}
#This is a graph showing observed deaths over time by using statistics of sum of dataframe data.
library(ggplot2)
ggplot(deaths_df3, aes(x = as.numeric(as.character(Year)), y = Maternal_Deaths, color = Age_Group)) +
  stat_summary(fun = sum, geom = "line", size = 1) +
  stat_summary(fun = sum, geom = "point") +
  labs(title = "Observed Maternal Deaths Over Time by Age Groupp",
       x = "Year", y = "Observed Maternal Deaths") +
  theme_minimal()
```


```{r,echo=FALSE,include=FALSE}
#We used variable maternal mortality rate to see maternal mortality rate over time by ethnicity and by using dataframe data and averages to plot lines and points.
library(ggplot2)
library(ggeffects)

ggplot(deaths_df3, aes(x = as.numeric(as.character(Year)), y = Maternal_Mortality_Rate, color = Ethnicity)) +
  stat_summary(fun = mean, geom = "line", size = 1) +
  stat_summary(fun = mean, geom = "point") +
  labs(
    title = "Maternal Mortality Rate Over Time by Ethnicity",
    x = "Year",
    y = "Maternal Mortalty Rate (per 100,000 live births)"
  ) +
  theme_minimal()
```

```{r,echo=FALSE,include=FALSE}
#We used variable maternal mortality rate to see maternal mortality rate over time by age group and by using dataframe data and averages to plot lines and points.
library(ggplot2)
library(ggeffects)
ggplot(deaths_df3, aes(x = as.numeric(as.character(Year)), y = Maternal_Mortality_Rate, color = Age_Group)) +
  stat_summary(fun =mean, geom = "line", size = 1) +
  stat_summary(fun = mean, geom = "point") +
  labs(title = "Maternal Mortality Rate Over Time by Age Group",
       x = "Year", y = "Maternal Mortaity Rate (per 100,000 live births)") +
  theme_minimal()
```

```{r,echo=FALSE,include=FALSE}
#This is a plot of maternal deaths over time by age group facet wrapped by age group by only utilizing dataframe data.
ggplot(deaths_df3, aes(x = Year, y = Maternal_Deaths, color = Age_Group)) +
  geom_point() +
  geom_line(aes(group = Age_Group)) +
  facet_wrap(~ Age_Group) +
  labs(title = "Maternal Deaths Over Time by Age Group")
```

```{r,echo=FALSE,include=FALSE}
#This is a plot of maternal deahs over time by age group facet wrapped by dobbs era by only utilizing dataframe data.
library(ggplot2)

ggplot(deaths_df3, aes(x = Year, y = Maternal_Deaths, color = Dobbs_Era)) +
  geom_point() +
  geom_line(aes(group = Dobbs_Era)) +
  labs(title = "Maternal Deaths Over Time by Dobbs Era")
```

These are boxplots of maternal deaths that show the distribution based on our created variable Dobbs Era (described later in Methods). Pre-Dobbs has a higher median as well as more variability in the death counts, than post-Dobbs. Both eras have outliers, but pre-Dobbs outliers are higher. Both eras are also right skewed.
```{r}

#ggplot(deaths_df3, aes(x = Age_Group, y = Maternal_Deaths)) +
  #geom_boxplot() +
  #labs(title = "Distribution of Maternal Deaths by Age Group")

#ggplot(deaths_df3, aes(x = Ethnicity, y = Maternal_Deaths)) +
  #geom_boxplot() +
  #theme(axis.text.x = element_text(angle = 45, hjust = 1))+
 # labs(title = "Distribution of Maternal Deaths by Ethnicity")

ggplot(deaths_df3, aes(x = Dobbs_Era, y = Maternal_Deaths)) +
  geom_boxplot() +
  labs(title = "Distribution of Maternal Deaths by Dobbs_era")

```



### Modeling and Results

#### Data Preprocessing

Our data preprocessing began with renaming columns for clarity and filtering the dataset to ensure the modeling process was based on relevant and reliable observations. Specifically, we retained only observations where maternal deaths were greater than zero and where live births exceeded 100, in order to reduce noise and improve model fit. Observations with missing (NA) values were also removed.

Due to the structure of the dataset, the fixed-effect variables Ethnicity and Age Group had to be derived from the existing variables Group and Subgroup. The Group variable contained general categories, such as "Race and Hispanic origin" or "Age", while the Subgroup variable provided the specific values associated with each group. For example:

- If Group was "Race and Hispanic origin", then Subgroup could be "Hispanic", "Black, not Hispanic", or "White, not Hispanic".

- If Group was "Age", then Subgroup could be "25 and under", "25–39", or "40 and over".

To create the Ethnicity variable, we extracted values from Subgroup when Group was "Race and Hispanic origin". In cases where Group was not "Race and Hispanic origin", the Ethnicity was set to "Unknown". Similarly, the Age Group variable was constructed from Subgroup when Group was "Age"; otherwise, it was also labeled "Unknown".

We converted the following variables to factor type: Year, Month, Ethnicity, and Age_Group. During model fitting, we encountered rank deficiency issues due to the "Unknown" level in Age_Group (which made estimates for that level non-estimable). However, for the sake of preserving the full structure and interpretability of the model, we retained the "Unknown" category rather than removing it.

To facilitate modeling, we created two intermediate data frames:

- One retained only ethnicity-related observations.

- The other retained only age group-related observations.

After cleaning and filtering each subset, we merged them to create a unified dataset. We explicitly defined factor levels for both Ethnicity and Age_Group, including an "Unknown" level in each. This ensured that model execution would not fail when including both variables as fixed effects.

Lastly, we created a new variable, Dobbs_Era, to distinguish between periods before and after the U.S. Supreme Court's overturning of Roe v. Wade on June 24, 2022. To do this, we first constructed a Date variable by combining Year, Month, and the first day of each month. We then used a cutoff date (2022-06-24) to classify each observation as "Pre-Dobbs" or "Post-Dobbs". This new factor variable was included as a fixed effect in the models to investigate whether the Dobbs decision had a measurable impact on maternal deaths.

#### Modeling

We created models with different combinations of fixed effects, including Ethnicity, Age Group, and Dobbs Era, along with Year as a random effect. Initially, we tested a Poisson model, which showed significant evidence of overdispersion. Due to this, we proceeded with the Negative Binomial Distribution as the family for our models.

During model fitting, we encountered issues with rank deficiency caused by the parameter Age_GroupUnknown, which was not estimable due to insufficient or non-informative data in that category.


Below is the output of the Poisson model that we ran, and then the overdispersion test.
<div class="scroll-box-vertical2">
```{r}

poissonmodel_glmm_all <- glmer(Maternal_Deaths ~ Ethnicity +Age_Group+ Dobbs_Era+(1|Year),
                              offset=log(Live_Births),
                              family = poisson(link = "log"), 
                              data = deaths_df3)

poissonmodel_glmm_all

```

</div>

```{r}
check_overdispersion(poissonmodel_glmm_all)

```


Below we run four Negative Binomial GLMM models. The output is displayed, and then a table summarizing the results follows.
<div class="scroll-box-vertical2">
```{r}
##with offset # all fixed effects
all_glmmodel_nb <- glmmTMB(
  Maternal_Deaths ~  Ethnicity + Age_Group +Dobbs_Era+ (1|Year),
  offset=log(Live_Births),
  family = nbinom2,
  data = deaths_df3
)
summary(all_glmmodel_nb)

```
</div>



<div class="scroll-box-vertical2">
```{r}
ethnicity_agegroup_glmmodel_nb <- glmmTMB(
  Maternal_Deaths ~  Ethnicity+ Age_Group + (1|Year),
  offset=log(Live_Births),
  family = nbinom2,
  data = deaths_df3
)
summary(ethnicity_agegroup_glmmodel_nb)
```
</div>
<div class="scroll-box-vertical2">
```{r}

##with no offset # all fixed effects #with not offset we can just use maternal mortality rate per 100,0000 live_births
allno_glmmodel_nb <- glmmTMB(
  Maternal_Deaths ~  Ethnicity + Age_Group+ Dobbs_Era + (1 |Year),
  family = nbinom2,
  data = deaths_df3
)
summary(allno_glmmodel_nb)

```
</div>
<div class="scroll-box-vertical2">
```{r}
ethnicity_agegroupno_glmmodel_nb <- glmmTMB(
  Maternal_Deaths ~  Ethnicity+ Age_Group + (1 |Year),
  family = nbinom2,
  data = deaths_df3
)
summary(ethnicity_agegroupno_glmmodel_nb)
```
</div>

Here is the table summarizing model performance parameters. 
<div class="scroll-box-vertical2">
```{r}


MuMIn::model.sel(all_glmmodel_nb,allno_glmmodel_nb, ethnicity_agegroup_glmmodel_nb, ethnicity_agegroupno_glmmodel_nb)

```
</div>
We also ran models including or excluding the offset (log(Live_Births)) to see if there were be differences in AIC and estimates. AIC is the value in which we used to see how well a model performed.
The best performing models were those with the fixed effects Ethnicity, Age Group, and Dobbs Era and random effect Year. The second place would be models with fixed effects Ethnicity and Age group and random effect Year. All models, however did drop the Age Group Unknown factor from inclusion.

  The best performing model according to AIC included all fixed effects without offset and had the AIC (4981.7), and the second best performing model included all fixed effect but with offset (AIC= 4999.7).
  

  However, even though the model not using offset has lower AIC it is incorrect model because it does not include live births or correct variance structure, the estimates are widely different and it operates with the expectation that all variables have the same exposure or each group has the same amount of live births For example not including offset assumes that people of different ethnicities gave the same birth amount each year which would not make sense given there are minorities that make up less of the population and thus will give less births. When omitting offset then all observations are assumed to have same exposure. Different years or ethnicity can have different numbers of births. Offset gives rate per exposure that is appropriate for each observation even if AIC value is higher. 

  The best performing model according to AIC included all fixed effects without offset and had the AIC (4981.7), and the second best performing model included all fixed effect but with offset (AIC= 4999.7). However, even though the model not using offset has lower AIC it is incorrect model because it does not include live births or correct variance structure, the estimates are widely different and it operates with the expectation that all variables have the same exposure or each group has the same amount of live births [@hilbe2011negative], [@nguyen2020guide], [@ha2023r]. For example not including offset assumes that people of different ethnicities gave the same birth amount each year which would not make sense given there are minorities that make up less of the population and thus will give less births. When omitting offset then all observations are assumed to have same exposure. Different years or ethnicity can have different numbers of births. Offset gives rate per exposure that is appropriate for each observation even if AIC value is higher. 



Thus our visualizations will be based on the model with offset and all fixed effects.

$$
\begin{align*}
\log(\mathbb{E}[\text{Maternal Deaths}_i]) &= \beta_0 
+ \beta_1 \cdot \text{Black}_i 
+ \beta_2 \cdot \text{White}_i 
+ \beta_3 \cdot \text{Hispanic}_i \\
&+ \beta_4 \cdot \text{American Indian or Alaska Native}_i 
+ \beta_5 \cdot \text{EthnicityUnknown}_i \\
&+ \beta_6 \cdot \text{Age 25-39}_i 
+ \beta_7 \cdot \text{Age 40 Plus}_i 
+ \beta_8 \cdot \text{Post Dobbs}_i 
+ b_{\text{Year}[i]} \\
&+ \log(\text{Live Births}_i)
\end{align*}
$$

Here is equation for the non-offset model:

$$
\begin{align*}
\log(\mathbb{E}[\text{Maternal Deaths}_i]) &= \beta_0 
+ \beta_1 \cdot \text{Black}_i 
+ \beta_2 \cdot \text{White}_i 
+ \beta_3 \cdot \text{Hispanic}_i \\
&+ \beta_4 \cdot \text{American Indian or Alaska Native}_i 
+ \beta_5 \cdot \text{EthnicityUnknown}_i \\
&+ \beta_6 \cdot \text{Age 25-39}_i 
+ \beta_7 \cdot \text{Age 40 Plus}_i 
+ \beta_8 \cdot \text{Post Dobbs}_i 
+ b_{\text{Year}[i]}
\end{align*}
$$

Here are the beta estimates in a equation model format for the offset model:

$$
\begin{align*}
\log({E}[\text{Maternal Deaths}_i]) &= -8.79 + 1.30\cdot\text{Black}_i + 0.27\cdot\text{White}_i	+ 0.14\cdot\text{Hispanic}_i \\ &+ 1.42\cdot\text{American Indian or Alaska Native}_i 
+ 0.03\cdot\text{EthnicityUnknown}_i \\ &+ 0.39 \cdot\text{Age 25--39}_i + 1.80\cdot\text{Age 40 Plus}_i -0.23\cdot\text{Post Dobbs}_i \\ &+ b_{\text{Year}[i]} + \log(\text{Live Births}_i)
\end{align*}
$$

#### Verifying Assumptions

Our chosen model adheres to all the model assumptions for a Negative Binomial GLMM. 

The response variable and the predictors have a linear relationship within the levels of random effects. 
```{r}


#The response variable and the predictors have a linear relationship within the levels of random effect
# Base partial residuals (approximate)
#Additionally a blue Loess lines is approximately close to this red reference line of 0 which helps evidence of linear relationship
#there are no atterns with scatter plot
resid_vals<-resid(all_glmmodel_nb,type = "pearson")
fitted_vals <- predict(all_glmmodel_nb,type = "response")

x <- jitter(fitted_vals)
y<-resid_vals

plot(x, y, main = "Residuals vs Fitted with LOESS model") #LOESS is smoother line
abline(h = 0, col = "red")#where residuals equal zero
lines(lowess(x, y), col = "blue", lwd = 2)#Blue LOESS line stays flat around 0


```



- The response variable is assumed to follow a negative binomial distribution, with $\sigma^2>\mu$.

```{r}
#check overdispersion
total_df %>% summarize(mean(Maternal_Deaths),
var(Maternal_Deaths))
```


- The residuals and random effects are independent.

```{r}

### The Independence of residual and Random Effects assumption is met because the dots of the residuals of the random effect (year) falls on the red refence line of  quantiles of random interceppt estimates vesus quantiles of normal distribution. A
#  Independence of Residuals and Random Effects
#random effects of year
#residuals leftover variation after accounting for fixed and random effects
#random effects show between group variation (how each group's slope or intercet differs)
#if are independent then model is correctly partitioning information
#residuals capture individual level random noise not explained by model and if
#there is no tie between residuals or random effects it upholds key assumption 
#that the random effects and residuals are independent of each other
re_year <- ranef(all_glmmodel_nb)$cond$Year[[1]]  # 'cond' = conditional mode


qqnorm(re_year, main = "Q-Q Plot of Random Intercepts in model(Year)")#plots quantiles of random intercept estimates vs quantiles of normal distriibution
qqline(re_year, col = "red")##dots follow reference line that shows where points would lie if distribution was normal, random intercepts are normally distributed



```

- The random effects are assumed to be normally distributed, with mean 0 and variance $\sigma$.
 
```{r}
#Normality of Random effects

###According to this graph there is Normality of random effect because points fall close to red line of Q-Q plot. The histogram falls a somewhat nromal distribution. And the blue density of the random effect distribution lies mostly within the red dashed line of the distribution of ideal normal distribution with same means. The approximmately normal blue density of random effect year could be expected to have mild deviations since we are workking with count data

#Points fall close to red line so random effects are approximately normal


re_year <- ranef(all_glmmodel_nb)$cond$Year[["(Intercept)"]] #extract year random reffect intercepts as numeric

qqnorm(re_year, main = "Q-Q Plot of Random Effect of (Year)")
qqline(re_year, col = "red")#points should roughly lie by this line if normal
hist(re_year, main = "Histogram of Random Effects of model ", xlab = "Random effect (Year)")

df_re <- data.frame(re = re_year)

ggplot(df_re, aes(x = re_year)) +
  geom_density(fill = "skyblue", alpha = 0.5) +#density curve of random effect distribution
  stat_function(fun = dnorm, args = list(mean = mean(re_year), sd = sd(re_year)),
                color = "red", linetype = "dashed") +###red is ideal normal distribution with same means and standard deviation
  ggtitle("Density of Random Effect (Year) model  with Normal Curve")

#since most of blue density is within red line 
#The random effect of year is approximately normal with some mild deviations which is common with count model
 
```


#### Results

This is the offset model summary output:
<div class="scroll-box-vertical2">
```{r,results='asis'}
sjPlot::tab_model(all_glmmodel_nb,
          transform = NULL, 
          show.se = TRUE,         # show standard error
          show.stat = TRUE,       # show z-values
          show.p = TRUE,           
          title = "GLMM negative binomial model with offset (Log Estimates)")
```
</div>

This is a model summary output with beta coefficients exponentiation into incidence rates ratios.
<div class="scroll-box-vertical2">
```{r,results='asis'}
library(sjPlot)
tab_model(all_glmmodel_nb,
          title = " GLMM negative binomial model with offset")

#residual variance is 7.99, variance in maternal deaths not explained by fixed effects or random effects
#variance for random intercept of group year is 0.03
#ICC- intraclass correlation- 0.00 of the proportion of the total variance explained by year, which is nothing year contributes nothing to explaining variation in maternal deaths it happens within years not between them
##5.5% of proportion of variance explained  by fixed effects only, they only exlain 5.5% of variance in maternal deaths sad
## conditional 5.9% is the proportion of variance contributed by fixed and random effects, random effect year contributes little to improving model

##our low variability could be due to not having a random effect like state or abortion access fixed variable
```
</div>

 - Black women had a 267% higher rate of maternal mortality compared to reference group (Asian), holding all other groups constant
 - White women have a  31% higher rate of maternal mortality compared to reference group (Asian) holding all other groups constant
 - Hispanic women have a 15% higher rate of maternal mortality compared to reference group (Asian), holding all other groups constant
 - American Indian or Alaska Native, have a 312% higher rate of maternal mortality compared to reference group Asian, holding all other groups constant
 - Unknown Ethnicity was not  statistically significant
 
 - Women 25-39 have a 37% higher rate of maternal mortality compared to reference group(Under 25) holding all other groups constant
 - Women 40 years and older have a 505% higher  rate of maternal mortality compared to reference group (under 25), holding all other groups constant 
 
 - There was a 20% lower rate in maternal mortality after Dobbs was passed compared to prior the passing of Dobbs
 - The residual variance is 7.99, variance in maternal deaths not explained by fixed effects or random effects
5.5% of proportion of variance explained by fixed effects only, they only explain 5.5% of variance in maternal deaths conditional 5.9% is the proportion of variance contributed by fixed and random effects, random effect year contributes little to improving model
 - Our low variability could be due to not having a random effect like state or other fixed effects to explain  variable like socioeconomic status, health care access, prenatal health etc.  
 - But even with low R2 the statistical significance of the fixed effects is still important because it highlights the significant relationship between the explanatory variables and maternal mortality. We are not so focused on prediction where a higher R2 would be more necessary for an adequate model

This is brief glimpse at non offset glmm model table estimates: 
<div class="scroll-box-vertical2">
```{r}
sjPlot::tab_model(allno_glmmodel_nb,
          transform = NULL, #original log and not exponiated
          show.se = TRUE,         # show standard error
          show.stat = TRUE,       # show z-values
          show.p = TRUE,           
          title = "Fixed Effects of GLMM model without offset (Log Estimates)")
```
</div>

<div class="scroll-box-vertical2">
```{r}
sjPlot::tab_model(allno_glmmodel_nb,
          title = "Fixed Effects from GLMM with outset(Incidence Rates Ratios)")

#residual variance is 0.01, variance in maternal deaths not explained by fixed effects or random effects
#variance for random intercept of group year is 0.03
#ICC- intraclass correlation-0.71 of the proportion of the total variance explained by year, which is nothing year contributes nothing to explaining variation in maternal deaths it happens within years not between them--SUSPPICiOUSLY HIGH
##97.1% of proportion of variance explained  by fixed effects only, they only explain 5.5% of variance in maternal deaths sad
## conditional 99.2% is the proportion of variance contributed by fixed and random effectsToo good to be true
```
</div>

  We will not be naming the incidence rates ratios for this not offset model since they are insanely inflated for example white women have a 98.8% higher rate of mortality than asian reference group and the age group 40 years and older is not statistically significant in this model but unknown ethnicity is found to be statistically significant.
Additionally, ICC- intra-class correlation-0.71 of the proportion of the total variance explained by year is suspiciously high.

  What is also too good to be true is the 97.1% of proportion of variance explained by fixed effects only,
and the conditional 99.2% is the proportion of variance contributed by fixed and random effects. Inflated R squared is further evidence of unaccounted exposure in a model without offset. 




```{r setup, include=FALSE}
options(repos = c(CRAN = "https://cloud.r-project.org"))
if (!require("performance"))install.packages("performance")#if required to install
library(performance)

if (!require("DHARMa"))install.packages("DHARMa")#if required to install
library(DHARMa)

if (!require("sjPlot"))install.packages("sjPlot")#if required to install
library(sjPlot, quietly = FALSE, warn.conflicts = FALSE)
if (!require("MuMIN"))install.packages("MuMIn")
library(MuMIn)
if (!require("bbmle"))install.packages("bbmle")
library("bbmle")
```




```{r}
#checking performance, R2 and singlulairty of effect variable and collinearity of model with offset
performance::check_model(all_glmmodel_nb, verbose=TRUE, residual_type = "normal")##interesting
check_singularity(all_glmmodel_nb)
check_collinearity(all_glmmodel_nb)
```

  This tests if model is overdispersed since the ratio given is around ,0.051 it is not indicative of overdispersion and neither is the p value which is much grater that (p <0.05) which also indicates there is no significant overdispersion with this model.


```{r}

overdisp_fun <- function(all_glmmodel_nb) {
  rdf <- df.residual(all_glmmodel_nb)
  rp <- residuals(all_glmmodel_nb, type = "pearson")
  Pearson.chisq <- sum(rp^2)
  prat <- Pearson.chisq / rdf
  pval <- pchisq(Pearson.chisq, df = rdf, lower.tail = FALSE)
  c(chisq = Pearson.chisq, ratio = prat, rdf = rdf, p = pval)
}

overdisp_fun(all_glmmodel_nb)

#ratio is around 1 which is good and not too indicative of overdispersion
#pp-value is greater that P<0.005 so that means there is no significant overdispersion
```



  These are predictions of maternal deaths utilizing the models of with and without offset by each individual fixed effect (Ethnicity, Age Group) as you can see there are vast differences between the plots with offset and without offset. 


```{r}
install.packages("ggeffects")  # if not yet installed

```

  Visually one can see without offset that the focus of the most maternal death counts go to white women who make up the majority of the population followed by black women. However with offset, the exposure is clear and there can be brought evidence of the unfortunate inflated maternal mortality rates of American Indian or Alaska Native women and black women. 
```{r}

library(ggeffects)
library(patchwork)

#  predictions by ethnicity
pred_eth1 <- ggpredict(all_glmmodel_nb, terms = "Ethnicity")
plot(pred_eth1)  + theme(axis.text.x = element_text(angle = 45, hjust = 1))+
 labs(
    title="Predicted Maternal Deaths by Ethnicity ",
      subtitle= "with offset", y="Maternal Deaths", x="Ethnicity"
  )+
  theme(plot.title = element_text(size =12 , face= "bold"), plot.subtitle = element_text(size = 10, face = "italic"))+ theme(plot.subtitle = element_text(hjust = 0.5))

pred_eth <- ggpredict(allno_glmmodel_nb, terms = "Ethnicity")
plot(pred_eth) + theme(axis.text.x = element_text(angle = 45, hjust = 1))+
 labs(
    title="Predicted Maternal Deaths by Ethnicity ",
      subtitle= "without offset", y="Maternal Deaths", x="Ethnicity"
  )+
  theme(plot.title = element_text(size = 12, face= "bold"), plot.subtitle = element_text(size = 10, face = "italic"))+ theme(plot.subtitle = element_text(hjust = 0.5))



```


  Without offset, the glmm model chose the population with the largest number of births amongst them 25-39 as having the greatest maternal mortality rate. However, the riskiest pregnancies are to women who are over the age of 40 but do not give as much birth as younger ages. The glmm model with offset graph shows clearly the risk of women over 40 giving birth. 

```{r}

library(ggeffects)
library(patchwork)

pred_age1 <- ggpredict(all_glmmodel_nb, terms = "Age_Group")
plot(pred_age1) + theme(axis.text.x = element_text(angle = 45, hjust = 1))+ labs(
    title="Predicted Maternal Deaths by Age Group",
      subtitle= "with offset", y="Maternal Deaths", x="Age Group"
  )+
  theme(plot.title = element_text(size = 12, face= "bold"), plot.subtitle = element_text(size = 10, face = "italic"))+ theme(plot.subtitle = element_text(hjust = 0.5))

pred_age <- ggpredict(allno_glmmodel_nb, terms = "Age_Group")
plot(pred_age) +  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +labs(
    title="Predicted Maternal Deaths by Age Group ",
      subtitle= "without offset", y="Maternal Deaths", x="Age Group"
  )+
  theme(plot.title = element_text(size = 12, face= "bold"), plot.subtitle = element_text(size = 10, face = "italic"))+ theme(plot.subtitle = element_text(hjust = 0.5))

```



  These are predictions of maternal deaths by using the models with and without offset and with predictions using the fixed effects of Ethnicity and age group. With the offset Glmm model the women at most risk for maternal mortality of black and American Indian and native Alaskan women over the age of 40, though the age range increased risk to all ethnicities. Without offset, the glmm model focuses on the age and ethnicity population that gives the most birth  such as 25-39 highest white women, followed by black, Hispanic, and unknown, but American Indian or Alaska Native are seen with very low mortality rate because there is perhaps a less birthing population among the ethnicity.


```{r}
library(ggeffects)
library(patchwork)
ethnicityage_effect <- ggpredict(all_glmmodel_nb, terms = c("Ethnicity","Age_Group"))

p1<-plot(ethnicityage_effect) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
 labs(
    title="Predicted Maternal Deaths by Ethnicity and Age Group",
      subtitle= "with offset", y="Maternal Deaths", x="Ethnicity", color = "Age Group"
  )+
  theme(plot.title = element_text(size = 8, face= "bold"), plot.subtitle = element_text(size = 8, face = "italic"))+ theme(plot.subtitle = element_text(hjust = 0.5))

ethnicityage_effect2<-ggpredict(allno_glmmodel_nb, terms = c("Ethnicity", "Age_Group"))
p2<-plot(ethnicityage_effect2) +theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  labs(
    title="Predicted Maternal Deaths by Ethnicity and Age Group",
      subtitle= "without offset", y="Maternal Deaths", x="Ethnicity", color = "Age Group"
  )+
  theme(plot.title = element_text(size = 8, face= "bold"), plot.subtitle = element_text(size = 8, face = "italic"))+ theme(plot.subtitle = element_text(hjust = 0.5))

p1 + p2


```

  These are predictions of maternal deaths by using the models with and without offset and with predictions using the fixed effects of Ethnicity and Dobbs Era.  As shown before the non offset model favors white women and has limitations on view of mortality of American Indian or Alaska Native women but similarly to the offset model, post-Dobbs has lower maternal mortality.  

```{r}
#As you can see plottting without offset leads to faulty plots--no way to over look?
library(ggeffects)
library(patchwork)
ethnicitydobbs_effect <- ggpredict(all_glmmodel_nb, terms = c("Ethnicity", "Dobbs_Era"))


p1<-plot(ethnicitydobbs_effect) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
 labs(
    title="Predicted Maternal Deaths by Ethnicity and Dobbs Era",
      subtitle= "with offset", y="Maternal Deaths", x="Ethnicity", color = "Dobbs Era"
  )+
  theme(plot.title = element_text(size = 8, face= "bold"), plot.subtitle = element_text(size = 8, face = "italic"))+ theme(plot.subtitle = element_text(hjust = 0.5))

ethnicitydobbs_effect2<-ggpredict(allno_glmmodel_nb, terms = c("Ethnicity",  "Dobbs_Era"))
p2<-plot(ethnicitydobbs_effect2) +
theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  labs(
    title="Predicted Maternal Deaths by Ethnicity and Dobbs Era",
      subtitle= "without offset", y="Maternal Deaths", x="Ethnicity", color = "Dobbs Era"
  )+
  theme(plot.title = element_text(size = 8, face = "bold"), plot.subtitle = element_text(size = 8, face = "italic")) +theme(plot.subtitle = element_text(hjust = 0.5))
  

p1 + p2

```

  This visualization  utilizes the offset model to predict maternal deaths over years by ethnicity with offset and shows the prediction of American Indian or Alaska Native women having the highest maternal mortality prediction followed by black women. In the non offset glmm model, Again white women are shown to have highest maternal mortality prediction followed by black women, with unknown and Hispanic women having around same rates and lowest is the low population of American Indian and Alaskan Native
```{r}
library(ggplot2)
library(patchwork)

# Predicted values for Year by Ethnicity
year_eth <- ggpredict(all_glmmodel_nb, terms = c("Year", "Ethnicity"))

# Plot
p1<-plot(year_eth) +
  labs(title = "Predicted Maternal Deaths Over Years by Ethnicity",
       x = "Year", y = "Predicted Maternal Deaths", subtitle = "with offset") + theme(plot.title = element_text(size = 9), plot.subtitle = element_text(size = 10, face = "italic"))+ theme(plot.subtitle = element_text(hjust = 0.5))


# Predicted values for Year by Ethnicity
year_eth2 <- ggpredict(allno_glmmodel_nb, terms = c("Year", "Ethnicity"))

# Plot
p2<-plot(year_eth2) +
  labs(title = "Predicted Maternal Deaths Over Years by Ethnicity", subtitle= "without offset",
       x = "Year", y = "Predicted Maternal Deaths") +theme(plot.title = element_text(size = 9), plot.subtitle = element_text(size = 10, face = "italic"))+ theme(plot.subtitle = element_text(hjust = 0.5))

p1/p2
```



  We find that using an offset for maternal count data per live births provided a model that may not have been the highest performing but showed cleared indications of at risk groups such as American Indian women, black women, and women over 40. The non offset model may have deceptively had higher performance numbers but regardless it still had black women as second place for maternal mortality. American Indian and Alaskan Natives have to fare with poorer health resources but are a smaller population unfortunately. Yet, there is strong evidence than Black women have been seen to face higher maternal mortality rates regardless of the use of offset or non offset method in glmm modeling. 
 
 
### Conclusion

  We had hypothesized that with Dobbs Era variable we could see if changes of maternal mortality occurred after the overturn of Roe v Wade. But unfortunately, we are working with provisional data and our exposure is nationwide. Future models could include states as a random effect or abortion access as a fixed effect. If so, abortion access could be a factor of 3 levels (extremely limited, somewhat limited, no limitations). It would be very interesting to see if including states and abortion access could give us a clearer picture of how maternal mortality is operating in general after the overturn of Roe v. Wade. 
  
  Regardless, minorities such as American Indian women and Black women are at higher risk of maternal mortality and this has been a cultural known for some time now. Most American Indians and Alaskan Natives on reservations receive healthcare from Indian Health Services and the physicians, nurses, and other health care providers who work for IHS are shuffled from reservation to reservation on a periodic basis giving very little time for rapport to build unless a physician chooses to stay with one reservation. There can be apprehension from this population as well as black Americans in seeing their physicians as well as being heard by their physicians. In the case for those receiving IHS, there is not as much resources and certain rules are a bit in their health facilities. Free healthcare does not mean better.
  
  Black women may struggle with being heard by their healthcare professionals and suffer birth complications that could have been mitigated if the professionals listened to their complaints. However, there could be more explanatory variables at play to explain why American Indian and Alaskan natives as well as Black women are facing higher maternal mortality. The higher maternal mortality for women over the age of 40 is to be expected as that is a high risk pregnancy and geriatric pregnancies start at age 35. However, perhaps age is only one part of the picture for women around the age of 40 have entered an age of increased stress to take care perhaps not only their own children but their parents as well, not to mention the additional health stresses that takes place as one ages. 
  
  Our results imply that American Indian women and black women are having higher mortality rates for reasons we can not be entirely clear of because we are not in the birthing room with the women when they give birth nor are we there for the immediate after birth to know of any complications these women could have faced. Furthermore, we are not present for the prenatal visits prior to birth and which behaviors or risks could have led to later maternal mortality. There are datasets that can follow women through their prenatal care and risks, however such data only later indicates if live births occur but not if the mother perishes.

  The inclusion of State as a random effect not only would help us see if maternal mortality as a whole could have been affected by differing abortion access but also see if there are differences among maternal mortality from different ethnicities (however not all states have American Indian or Alaska Native reservations or have diverse populations).
  
  Limitations of this study included the integrity of model  dependent on the inclusion of age group and ethnicity data that were actually not applicable but had to be denoted as "Unknown" for model to work. Additionally, the data is provisional and subject to change and is not final which may make our models not include finalized data and may make our model incorrect if the finalized data is vastly different than the data we are using currently.
  
## References
